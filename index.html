<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4B4E6D" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Page Title -->
  <title>Persian Music Scales</title>

  <!-- Description for SEO -->
  <meta name="description" content="Explore Persian Music Scales with interactive features. Learn about microtones and traditional music scales." />

  <!-- Open Graph Metadata for Link Sharing -->
  <meta property="og:title" content="Persian Music Scale App" />
  <meta property="og:description" content="Persian Music Education ‚Äì Scales, Microtones, and Innovation at Your Fingertips" />
  <meta property="og:url" content="https://persianmusicscales.github.io/Persian-Music-Scales-App/" />
  <meta property="og:type" content="website" />

  <!-- Link to External CSS -->
  <link rel="stylesheet" href="csss/indexstyle.css" />
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1 id="pageTitle">Persian Music Scales</h1>
    <!-- Language Selector positioned at top right -->
    <select id="languageSelector" class="language-selector" aria-label="Select Language">
      <option value="en">en</option>
      <option value="fr">fr</option>
      <option value="fa">ŸÅÿß</option>
    </select>
  </header>

  <!-- SCALE CONTROLS BELOW HEADER -->
  <div class="scale-controls">
    <select id="scaleSelector" aria-label="Select Scale">
      <option value="Shur">Shur</option>
      <option value="nava">Nava</option>
      <option value="segah">Segah</option>
      <option value="homayoun">Homayoun</option>
      <option value="esfahan">Esfahan</option>
      <option value="chahargah">Chahargah</option>
      <option value="mahur">Mahur / Rast Panjgah</option>
    </select>
    
    <!-- Avazha Floating Icon -->
    <div id="avazhaContainer" class="avazha-container">
      <button id="avazhaButton" class="avazha-button">
        <span id="avazhaLabel">Avazha</span>
      </button>
      <!-- Expandable Columns -->
      <div id="avazhaColumns" class="avazha-columns hidden">
        <div class="avazha-column">
          <div class="avazha-item" data-translate="avazha.abuAta">Abu Ata</div>
          <div class="avazha-item" data-translate="avazha.bayatTork">Bayat Tork</div>
          <div class="avazha-item" data-translate="avazha.afshari">Afshari</div>
          <div class="avazha-item" data-translate="avazha.dashti">Dashti</div>
        </div>
        <div class="avazha-column" id="avazhaDynamicColumn">
          <!-- Dynamic labels will be inserted here via JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Dynamic Label -->
    <span id="labelAtZeroAngle"></span>
  </div>

  <!-- MAIN: Center the circle, place legend/footer inside -->
  <main>
    <!-- Circle container -->
    <div class="container" id="circleContainer">
      <div class="diatonic-scale" id="diatonicScale"></div>
      <div class="outer-scale" id="outerScale"></div>
    </div>

    <!-- Play Scale Button Container -->
    <div class="play-button-container">
      <button id="playScale">‚ñ∫ Play Scale</button>
    </div>
     
    <!-- Add to Home Screen Button -->
    <button id="add-to-home">Install App</button>
    
    <!-- My App Button -->
    <div class="my-app-container" id="myAppContainer">
      <button id="myAppButton" class="my-app-button">
        <div class="my-app-icon">
          <!-- Insert Your SVG Icon Here -->
          <img src="assets/icons/myapp_icon.svg" alt="My App Icon">
        </div>
      </button>
      <!-- Bounded Text Label for My App Button -->
      <span class="my-app-label" data-translate="myAppLabel">App</span>
    </div>

    <!-- Legend at bottom-left, above bottom nav -->
    <div class="legend">
      <div class="legend-row">
        <div class="legend-item">
          <span class="color-box" style="background: gray;"></span>
          200 cents
        </div>
        <div class="legend-item">
          <span class="color-box" style="background: black;"></span>
          100 cents
        </div>
      </div>
      <div class="legend-row">
        <div class="legend-item">
          <span class="color-box" style="background: pink;"></span>
          150 cents
        </div>
        <div class="legend-item">
          <span class="color-box" style="background: green;"></span>
          250 cents
        </div>
      </div>
    </div>

    <!-- Footer at bottom-right, above bottom nav -->
    <footer>
      Copyright ¬© 2024
      <br/>
      Pouya Hosseini
    </footer>
  </main>

  <!-- Bottom Menu (fixed) -->
  <nav class="bottom-nav">
    <a href="index.html">
      <div class="nav-icon">üéº</div>
      <span data-translate="bottomNav.scales">Scales</span>
    </a>
    <a href="tuner.html">
      <div class="nav-icon">üéπ</div>
      <span data-translate="bottomNav.tuner">Tuner</span>
    </a>
    <a href="guide.html">
      <div class="nav-icon">üìñ</div>
      <span data-translate="bottomNav.guide">Guide</span>
    </a>
    <a href="about.html">
      <div class="nav-icon">‚ÑπÔ∏è</div>
      <span data-translate="bottomNav.about">About</span>
    </a>
  </nav>

  <!-- Pop-up Modal for My App Installation Instructions -->
  <div class="popup-overlay" id="installPopup">
    <div class="popup-modal">
      <div class="popup-header">
        <div class="popup-title" id="popupTitle">Install The App</div>
        <button class="popup-close" id="closePopup">&times;</button>
      </div>
      <div class="popup-content" id="popupContent">
        <div class="popup-instruction">
          <!-- Share Icon SVG -->
          <img src="assets/icons/share.svg" alt="Share Icon">
          <span id="instructionShare">Tap the Share Button</span>
        </div>
        <div class="popup-instruction">
          <!-- Add to Home Screen Icon SVG -->
          <img src="assets/icons/add_home.svg" alt="Add to Home Screen Icon">
          <span id="instructionAdd">Add to Home Screen</span>
        </div>
      </div>
      <button class="popup-button" id="dismissPopup">Understand</button>
    </div>
  </div>

  <!-- Service Worker Registration -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
          .then(() => console.log("Service Worker registered!"))
          .catch(err => console.log("Service Worker registration failed:", err));
      });
    }
  </script>

  <script>
    let deferredPrompt;

    // Listen for the `beforeinstallprompt` event
    window.addEventListener('beforeinstallprompt', (event) => {
      console.log('beforeinstallprompt event fired');
      // Prevent the mini-infobar from appearing
      event.preventDefault();
      // Save the event to use later
      deferredPrompt = event;

      // Show the A2HS button after an interaction
      playScaleBtn.addEventListener('click', () => {
        // Display the A2HS button after the "Play Scale" interaction
        const a2hsButton = document.getElementById('add-to-home');
        a2hsButton.style.display = 'block';

        // Add event listener to the A2HS button
        a2hsButton.addEventListener('click', () => {
          a2hsButton.style.display = 'none'; // Hide the button
          deferredPrompt.prompt(); // Show the A2HS prompt

          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the A2HS prompt');
            } else {
              console.log('User dismissed the A2HS prompt');
            }
            deferredPrompt = null; // Clear the deferredPrompt
          });
        });
      });
    });
  </script>

  <!-- Main Script (Scale + Avazha + Rotation logic) -->
  <script>
    /*
      The code below integrates rotation, dynamic labels, Avazha, and My App features.
      It ensures that all functionalities coexist without conflicts.
    */

    const scaleSelector    = document.getElementById("scaleSelector");
    const languageSelector = document.getElementById("languageSelector");
    const circleContainer  = document.getElementById("circleContainer");
    const outerScale       = document.getElementById("outerScale");
    const diatonicScale    = document.getElementById("diatonicScale");
    const labelAtZeroAngle = document.getElementById("labelAtZeroAngle");
    const playScaleBtn     = document.getElementById("playScale");
    const pageTitle        = document.getElementById("pageTitle");
    const bottomNavLabels  = document.querySelectorAll('.bottom-nav span[data-translate]');

    const myAppButton      = document.getElementById("myAppButton");
    const installPopup     = document.getElementById("installPopup");
    const closePopupBtn    = document.getElementById("closePopup");
    const dismissPopupBtn  = document.getElementById("dismissPopup");
    const myAppContainer   = document.getElementById("myAppContainer");

    let rotation        = 0;
    let currentLanguage = "en";

    // Example translations
    const translations = {
      fr: {
        displayLabels: ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si"],
        koron: "Koron",
        sori: "Sori",
        scales: {
          Shur: "Shur",
          nava: "Nava",
          segah: "Segah",
          homayoun: "Homayoun",
          esfahan: "Esfahan",
          chahargah: "Chahargah",
          mahur: "Mahur / Rast Panjgah",
        },
        playButton: "‚ñ∫ Jouer la Gamme",
        title: "Persian Music Scales",
        bottomNav: {
          scales: "√âchelles",
          tuner: "Accordeur",
          guide: "Guide",
          about: "√Ä propos"
        },
        avazha: "Avazha",
        avazhaItems: {
          abuAta: "Abu Ata",
          bayatTork: "Bayat Tork",
          afshari: "Afshari",
          dashti: "Dashti"
        },
        installPopup: {
          title: "Install the App",
          instructions: "To install this application, follow the steps below.",
          share: "Tap the Share Button",
          addHome: "Add to Home Screen",
          dismiss: "Close"
        },
        myAppLabel: "App"
      },
      en: {
        displayLabels: ["C", "D", "E", "F", "G", "A", "B"],
        koron: "Koron",
        sori: "Sori",
        scales: {
          Shur: "Shur",
          nava: "Nava",
          segah: "Segah",
          homayoun: "Homayoun",
          esfahan: "Esfahan",
          chahargah: "Chahargah",
          mahur: "Mahur / Rast Panjgah",
        },
        playButton: "‚ñ∫ Play Scale",
        title: "Persian Music Scales",
        bottomNav: {
          scales: "Scales",
          tuner: "Tuner",
          guide: "Guide",
          about: "About"
        },
        avazha: "Avazha",
        avazhaItems: {
          abuAta: "Abu Ata",
          bayatTork: "Bayat Tork",
          afshari: "Afshari",
          dashti: "Dashti"
        },
        installPopup: {
          title: "Install the App",
          instructions: "To install this Application, Follow the Steps Below.",
          share: "Tap the Share Button",
          addHome: "Add to Home Screen",
          dismiss: "Close"
        },
        myAppLabel: "App"
      },
      fa: {
        displayLabels: ["ÿØŸà", "ÿ±Ÿê", "ŸÖ€å", "ŸÅÿß", "ÿ≥ŸèŸÑ ", "ŸÑÿß", "ÿ≥€å "],
        koron: "⁄©Ÿèÿ±ŸèŸÜ",
        sori: "ÿ≥Ÿèÿ±€å",
        scales: {
          Shur: "ÿ¥Ÿàÿ±",
          nava: "ŸÜŸàÿß",
          segah: "ÿ≥Ÿá‚Äå⁄ØÿßŸá",
          homayoun: "ŸáŸÖÿß€åŸàŸÜ",
          esfahan: "ÿßÿµŸÅŸáÿßŸÜ",
          chahargah: "⁄ÜŸáÿßÿ±⁄ØÿßŸá",
          mahur: "ŸÖÿßŸáŸàÿ± / ÿ±ÿßÿ≥ÿ™ ŸæŸÜÿ¨⁄ØÿßŸá",
        },
        playButton: "‚ñ∫ ŸæÿÆÿ¥ ⁄ØÿßŸÖ",
        title: "⁄ØÿßŸÖ‚ÄåŸáÿß€å ŸÖŸàÿ≥€åŸÇ€å ÿß€åÿ±ÿßŸÜ€å",
        bottomNav: {
          scales: "⁄ØÿßŸÖ‚ÄåŸáÿß",
          tuner: "ÿ™€åŸàŸÜÿ±",
          guide: "ÿ±ÿßŸáŸÜŸÖÿß",
          about: "ÿØÿ±ÿ®ÿßÿ±Ÿá"
        },
        avazha: "ÿ¢Ÿàÿßÿ≤Ÿáÿß",
        avazhaItems: {
          abuAta: "ÿßÿ®Ÿàÿπÿ∑ÿß",
          bayatTork: "ÿ®€åÿßÿ™ ÿ™ÿ±⁄©",
          afshari: "ÿßŸÅÿ¥ÿßÿ±€å",
          dashti: "ÿØÿ¥ÿ™€å"
        },
        installPopup: {
          title: "ŸÜÿµÿ® ÿ®ÿ±ŸÜÿßŸÖŸá",
          instructions: "ÿ®ÿ±ÿß€å ŸÜÿµÿ® ÿß€åŸÜ ÿ®ÿ±ŸÜÿßŸÖŸáÿå ŸÖÿ±ÿßÿ≠ŸÑ ÿ≤€åÿ± ÿ±ÿß ÿØŸÜÿ®ÿßŸÑ ⁄©ŸÜ€åÿØ.",
          share: "ÿØ⁄©ŸÖŸá Share ÿ±ÿß ÿ®ÿ≤ŸÜ€åÿØ.",
          addHome: "ÿØ⁄©ŸÖŸá add to Home Screen ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.",
          dismiss: "ÿ®ÿ≥ÿ™ŸÜ"
        },
        myAppLabel: "ŸÜÿµÿ®"
      }
    };

    const parseableNotes = ["C", "D", "E", "F", "G", "A", "B"];

    const scaleData = {
      Shur: {
        angles: [0, 45, 90, 150, 210, 240, 300],
        colors:
          "conic-gradient(pink 0deg 45deg, pink 45deg 90deg, gray 90deg 150deg, gray 150deg 210deg, black 210deg 240deg, gray 240deg 300deg, gray 300deg 360deg)"
      },
      nava: {
        angles: [0, 60, 90, 150, 210, 255, 300],
        colors:
          "conic-gradient(gray 0deg 60deg, black 60deg 90deg, gray 90deg 150deg, gray 150deg 210deg, pink 210deg 255deg, pink 255deg 300deg, gray 300deg 360deg)"
      },
      segah: {
        angles: [0, 60, 105, 150, 210, 255, 300],
        colors:
          "conic-gradient(gray 0deg 60deg, pink 60deg 105deg, pink 105deg 150deg, gray 150deg 210deg, pink 210deg 255deg, pink 255deg 300deg, gray 300deg 360deg)"
      },
      homayoun: {
        angles: [0, 45, 120, 150, 210, 240, 300],
        colors:
          "conic-gradient(pink 0deg 45deg, green 45deg 120deg, black 120deg 150deg, gray 150deg 210deg, black 210deg 240deg, gray 240deg 300deg, gray 300deg 360deg)"
      },
      esfahan: {
        angles: [0, 60, 90, 150, 210, 255, 330],
        colors:
          "conic-gradient(gray 0deg 60deg, black 60deg 90deg, gray 90deg 150deg, gray 150deg 210deg, pink 210deg 255deg, green 255deg 330deg, black 330deg 360deg)"
      },
      chahargah: {
        angles: [0, 45, 120, 150, 210, 255, 330],
        colors:
          "conic-gradient(pink 0deg 45deg, green 45deg 120deg, black 120deg 150deg, gray 150deg 210deg, pink 210deg 255deg, green 255deg 330deg, black 330deg 360deg)"
      },
      mahur: {
        angles: [0, 60, 120, 150, 210, 270, 330],
        colors:
          "conic-gradient(gray 0deg 60deg, gray 60deg 120deg, black 120deg 150deg, gray 150deg 210deg, gray 210deg 270deg, gray 270deg 330deg, black 330deg 360deg)"
      }
    };

    const diatonicAngles = [0, 60, 120, 150, 210, 270, 330];

    function updateOuterScale(scale) {
      const { angles, colors } = scaleData[scale];
      outerScale.style.background = colors;
      outerScale.innerHTML = "";

      angles.forEach((angle) => {
        const line = document.createElement("div");
        line.classList.add("line");
        line.style.transform = `rotate(${angle}deg)`;
        outerScale.appendChild(line);
      });
    }

    function updateStaticLabels() {
      diatonicScale.innerHTML = "";
      const { displayLabels } = translations[currentLanguage];

      diatonicAngles.forEach((angle, index) => {
        const line = document.createElement("div");
        line.classList.add("line-diatonic");
        line.style.transform = `rotate(${angle}deg)`;
        diatonicScale.appendChild(line);

        const label = document.createElement("div");
        label.classList.add("label");
        label.innerHTML = displayLabels[index]; // Using innerHTML for possible superscripts

        const radians = (angle - 90) * (Math.PI / 180);
        label.style.top = `${50 + 40 * Math.sin(radians)}%`;
        label.style.left= `${50 + 40 * Math.cos(radians)}%`;
        diatonicScale.appendChild(label);
      });
    }

    function normalizeAngle(a) {
      return (a + 360) % 360;
    }

    function findClosestLabel(angle, displayLabels, koron, sori) {
      const normalizedAngle = normalizeAngle(angle);
      const rotatedAngles = diatonicAngles.map(a => normalizeAngle(a + rotation));

      let bestDiff = 360;
      let bestList = [];

      rotatedAngles.forEach((diaAng, idx) => {
        let diff = normalizedAngle - diaAng;
        diff = normalizeAngle(diff);
        if (diff > 180) diff -= 360;
        const absDiff = Math.abs(diff);

        if (absDiff < bestDiff) {
          bestDiff = absDiff;
          bestList = [{ index: idx, diff }];
        } else if (absDiff === bestDiff) {
          bestList.push({ index: idx, diff });
        }
      });

      const dispArr  = [];
      const parseArr = [];

      bestList.forEach(({ index, diff }) => {
        let disp = displayLabels[index];
        let prse = parseableNotes[index];

        if (diff === 30) {
          // Sharp
          if (currentLanguage === "fa") disp += " ÿØ€åÿ≤";
          else disp += "‚ôØ";
          prse += "#";
        } else if (diff === -30) {
          // Flat
          if (currentLanguage === "fa") disp += " ÿ®ŸÖŸÑ";
          else disp += "‚ô≠";
          prse += "b";
        } else if (diff === 15) {
          // Sori
          disp += `<sup>${sori}</sup>`;
          prse += " sori";
        } else if (diff === -15) {
          // Koron
          disp += `<sup>${koron}</sup>`;
          prse += " koron";
        }
        dispArr.push(disp);
        parseArr.push(prse);
      });

      return {
        displayText: dispArr.join("/"),
        parseableText: parseArr.join("/")
      };
    }

    function updateDynamicLabels() {
      const scaleName = scaleSelector.value;
      const { angles } = scaleData[scaleName];
      const { displayLabels, koron, sori } = translations[currentLanguage];

      outerScale.querySelectorAll(".dynamic-label").forEach(d => d.remove());

      angles.forEach(angle => {
        const { displayText, parseableText } = findClosestLabel(angle, displayLabels, koron, sori);

        const labelDiv = document.createElement("div");
        labelDiv.classList.add("dynamic-label");
        labelDiv.dataset.allNotes = parseableText;
        labelDiv.dataset.singleNote = parseableText.split("/")[0].trim();

        labelDiv.innerHTML = displayText;

        const radians = (angle - 90) * (Math.PI / 180);
        labelDiv.style.top  = `${50 + 45 * Math.sin(radians)}%`;
        labelDiv.style.left = `${50 + 45 * Math.cos(radians)}%`;

        outerScale.appendChild(labelDiv);
      });

      // 12 o'clock label
      const zeroResult = findClosestLabel(0, displayLabels, koron, sori);
      labelAtZeroAngle.innerHTML = zeroResult.displayText;
      labelAtZeroAngle.dataset.allNotes   = zeroResult.parseableText;
      labelAtZeroAngle.dataset.singleNote = zeroResult.parseableText.split("/")[0].trim();
    }

    function rotateScale(evt) {
      const rect = circleContainer.getBoundingClientRect();
      const clickX = evt.clientX - rect.left - rect.width / 2;
      rotation += clickX >= 0 ? 15 : -15;

      diatonicScale.style.transform = `rotate(${rotation}deg)`;
      updateDynamicLabels();
      populateAvazhaDynamicColumn(); // Update Avazha dynamic labels after rotation

      if (navigator.vibrate) navigator.vibrate(50);
    }

    // ===== Avazha Functionality =====
    const avazhaContainer = document.getElementById('avazhaContainer');
    const avazhaButton = document.getElementById('avazhaButton');
    const avazhaColumns = document.getElementById('avazhaColumns');
    const avazhaDynamicColumn = document.getElementById('avazhaDynamicColumn');

    function toggleAvazhaColumns() {
      avazhaColumns.classList.toggle('hidden');
    }

    avazhaButton.addEventListener('click', toggleAvazhaColumns);

    function updateAvazhaVisibility() {
      const selectedScale = scaleSelector.value;
      if (selectedScale === 'Shur') {
        avazhaContainer.style.display = 'flex';
        populateAvazhaDynamicColumn();
      } else {
        avazhaContainer.style.display = 'none';
        avazhaColumns.classList.add('hidden');
      }
    }

    function populateAvazhaDynamicColumn() {
      avazhaDynamicColumn.innerHTML = ''; // Clear existing content
      const dynamicLabels = outerScale.querySelectorAll('.dynamic-label');
      // Extract the second, third, fourth, and fifth labels
      const labelsArray = Array.from(dynamicLabels).slice(1, 5);

      labelsArray.forEach(label => {
        const displayText = label.innerHTML;
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("avazha-item");
        itemDiv.innerHTML = displayText;
        avazhaDynamicColumn.appendChild(itemDiv);
      });
    }

    function updateUIControls() {
      const { scales, playButton, title, bottomNav, avazha, avazhaItems, installPopup, myAppLabel } = translations[currentLanguage];
      Array.from(scaleSelector.options).forEach(opt => {
        opt.textContent = scales[opt.value];
      });
      playScaleBtn.textContent = playButton;

      // Update the page title
      document.title = title;
      pageTitle.textContent = title;

      // Update bottom navigation labels
      bottomNavLabels.forEach(label => {
        const keyPath = label.getAttribute('data-translate').split('.');
        let text = translations[currentLanguage];
        keyPath.forEach(key => {
          text = text[key];
        });
        label.textContent = text;
      });

      // Update Avazha label
      updateAvazhaLabel();

      // Update Avazha fixed items translations
      const avazhaFixedItems = document.querySelectorAll('.avazha-column:first-child .avazha-item[data-translate]');
      avazhaFixedItems.forEach(item => {
        const key = item.getAttribute('data-translate').split('.')[1]; // e.g., "abuAta"
        if (translations[currentLanguage].avazhaItems && translations[currentLanguage].avazhaItems[key]) {
          item.textContent = translations[currentLanguage].avazhaItems[key];
        }
      });

      // Update Pop-up Content
      updatePopupContent();

      // Update My App Label
      const myAppLabelElement = document.querySelector('.my-app-label');
      if (myAppLabelElement) {
        myAppLabelElement.textContent = myAppLabel;
      }
    }

    function updateAvazhaLabel() {
      const avazhaLabel = document.getElementById('avazhaLabel');
      const translation = translations[currentLanguage].avazha;
      avazhaLabel.textContent = translation;
    }

    languageSelector.addEventListener("change", () => {
      currentLanguage = languageSelector.value;
      updateStaticLabels();
      updateDynamicLabels();
      updateUIControls();
      populateAvazhaDynamicColumn();
      // Adjust RTL for Farsi
      if (currentLanguage === 'fa') {
        document.body.classList.add('rtl');
      } else {
        document.body.classList.remove('rtl');
      }
    });

    scaleSelector.addEventListener("change", () => {
      updateOuterScale(scaleSelector.value);
      updateDynamicLabels();
      updateUIControls();
      updateAvazhaVisibility();
      if (navigator.vibrate) navigator.vibrate(100);
    });

    circleContainer.addEventListener("click", rotateScale);

    // ===== My App Functionality =====

    function isPWAInstalled() {
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }

    function toggleMyAppButton() {
      if (!isPWAInstalled()) {
        myAppContainer.style.display = 'flex';
      } else {
        myAppContainer.style.display = 'none';
      }
    }

    myAppButton.addEventListener("click", () => {
      installPopup.style.display = 'flex';
    });

    closePopupBtn.addEventListener("click", () => {
      installPopup.style.display = 'none';
    });

    dismissPopupBtn.addEventListener("click", () => {
      installPopup.style.display = 'none';
    });

    function updatePopupContent() {
      const { installPopup } = translations[currentLanguage];
      document.getElementById('popupTitle').textContent = installPopup.title;
      document.getElementById('instructionShare').textContent = installPopup.share;
      document.getElementById('instructionAdd').textContent = installPopup.addHome;
      dismissPopupBtn.textContent = installPopup.dismiss;
    }

    window.addEventListener('appinstalled', () => {
      myAppContainer.style.display = 'none';
      console.log('PWA was installed');
    });

    updateOuterScale("Shur");
    updateStaticLabels();
    updateDynamicLabels();
    updateUIControls();
    updateAvazhaVisibility();
    toggleMyAppButton();

    /* AUDIO + Teeter code (Play Scale) */
    const baseFrequencies = {
      "Do": 261.63, "Re": 293.66, "Mi": 329.63, "Fa": 349.23,
      "Sol": 392.00, "La": 440.00, "Si": 493.88,
      "C": 261.63,   "D": 293.66,  "E": 329.63,  "F": 349.23,
      "G": 392.00,   "A": 440.00,  "B": 493.88
    };

    function adjustFrequencyByCents(freq, cents) {
      return freq * Math.pow(2, cents / 1200);
    }

    function parseNote(note) {
      const match = note.match(/^([A-G]|Do|Re|Mi|Fa|Sol|La|Si)([#b]?)(?:\s+(koron|sori))?$/i);
      if (!match) return null;

      const base = match[1];
      let frequency = baseFrequencies[base];
      if (!frequency) return null;

      if (match[2] === "#") {
        frequency = adjustFrequencyByCents(frequency, 100);
      } else if (match[2] === "b") {
        frequency = adjustFrequencyByCents(frequency, -100);
      }
      if (match[3] && match[3].toLowerCase() === "koron") {
        frequency = adjustFrequencyByCents(frequency, -50);
      } else if (match[3] && match[3].toLowerCase() === "sori") {
        frequency = adjustFrequencyByCents(frequency, 50);
      }

      return frequency;
    }

    function playNote(audioCtx, frequency, duration, startTime) {
      if (!frequency) return;

      const oscillator = audioCtx.createOscillator();
      oscillator.type = "sine";

      const gainNode = audioCtx.createGain();
      gainNode.gain.setValueAtTime(0, startTime);

      gainNode.gain.linearRampToValueAtTime(0.8, startTime + 0.02);
      gainNode.gain.setValueAtTime(0.8, startTime + duration - 0.1);
      gainNode.gain.linearRampToValueAtTime(0, startTime + duration);

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.frequency.value = frequency;

      oscillator.start(startTime);
      oscillator.stop(startTime + duration);
    }

    function animateLabelDuringNote(singleNote, audioCtx, startTime, duration) {
      const now = audioCtx.currentTime;
      const startDelayMs = Math.max(0, (startTime - now) * 1000);
      const endDelayMs   = startDelayMs + duration * 1000;

      setTimeout(() => {
        const labels = outerScale.querySelectorAll(".dynamic-label");
        labels.forEach(label => {
          if (label.dataset.singleNote === singleNote) {
            label.classList.add("teeter-animate");
          }
        });
      }, startDelayMs);

      setTimeout(() => {
        const labels = outerScale.querySelectorAll(".dynamic-label");
        labels.forEach(label => {
          if (label.dataset.singleNote === singleNote) {
            label.classList.remove("teeter-animate");
          }
        });
      }, endDelayMs);
    }

    function playOuterScale() {
      const scaleName = scaleSelector.value;
      const { angles } = scaleData[scaleName];
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let currentTime = audioCtx.currentTime;

      const noteDuration = 1.0;
      let lastFreq = 0;
      let firstNoteFrequency = null; // Store the first note's frequency

      for (let i = 0; i < 7; i++) {
        const angle = angles[i % angles.length];
        const { parseableText } = findClosestLabel(
          angle,
          translations[currentLanguage].displayLabels,
          translations[currentLanguage].koron,
          translations[currentLanguage].sori
        );
        const singleNote = parseableText.split("/")[0].trim();
        let freq = parseNote(singleNote);

        if (freq) {
          if (i === 0) {
            firstNoteFrequency = freq;
          }
          while (freq <= lastFreq) {
            freq *= 2;
          }
          playNote(audioCtx, freq, noteDuration, currentTime);
          animateLabelDuringNote(singleNote, audioCtx, currentTime, 1.0);

          lastFreq = freq;
          currentTime += 1.0;
        }
      }

      // Play the first note again in the next octave
      if (firstNoteFrequency) {
        const freqNextOctave = firstNoteFrequency * 2;
        playNote(audioCtx, freqNextOctave, noteDuration, currentTime);
        animateLabelDuringNote(parseableNotes[0], audioCtx, currentTime, 1.0);
      }
    }

    playScaleBtn.addEventListener("click", playOuterScale);
  </script>

  <!-- Add language detection script before the closing body tag -->
  <script>
    const userLang = navigator.language || navigator.languages[0];
    const langSelector = document.getElementById("languageSelector");

    if (userLang.includes("fa")) {
      langSelector.value = "fa"; // Set to Persian
    } else if (userLang.includes("fr")) {
      langSelector.value = "fr"; // Set to French
    } else {
      langSelector.value = "en"; // Default to English
    }
    // Trigger language switch based on selection
    langSelector.dispatchEvent(new Event("change"));
  </script>

  <!-- Add to Home Screen and My App Modal Scripts -->
  <script>
    window.addEventListener('load', () => {
      toggleMyAppButton();
    });

    function showInstallPopup() {
      if (!isPWAInstalled()) {
        installPopup.style.display = 'flex';
      }
    }
  </script>
</body>
</html>
